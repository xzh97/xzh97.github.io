<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="xzh">


    <meta name="subtitle" content="何须仰望他人，自己亦是风景">


    <meta name="description" content="xzh的个人博客">


    <meta name="keywords" content="xzh,博客">


<title>【Webpack】项目优化 | 追梦的蚂蚁</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/gitalk/1.7.0/gitalk.min.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    
    <script src="https://cdn.bootcdn.net/ajax/libs/gitalk/1.7.0/gitalk.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="追梦的蚂蚁" type="application/atom+xml">
</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">xzh97&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/categories">Categories</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">xzh97&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/categories">Categories</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">【Webpack】项目优化</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">xzh</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">December 3, 2020&nbsp;&nbsp;16:52:46</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/%E5%89%8D%E7%AB%AF/">前端</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="前言"><a class="header-anchor" href="#前言"></a>前言</h2>
<p>今天我们来学习如何用webpack来优化项目。</p>
<h2 id="优化方式"><a class="header-anchor" href="#优化方式"></a>优化方式</h2>
<h3 id="优化无用的css"><a class="header-anchor" href="#优化无用的css"></a>优化无用的css</h3>
<p>顾名思义，就是把没有用到的css样式优化掉，可以减少构建包的大小</p>
<p>主要是通过插件<code>purgecss-webpack-plugin</code>来实现。</p>
<ul>
<li><a href="https://www.purgecss.cn/guides/vue.html#use-the-vue-cli-plugin" target="_blank" rel="noopener">vue-cli3使用PurgecssWebpackPlugin</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里想弄个栗子的，但是这个`vue-cli-plugin-purgecss`的插件一直装不上只能作罢</span></span><br></pre></td></tr></table></figure>
<ul>
<li><a href="https://www.purgecss.cn/plugins/webpack.html#%E5%AE%89%E8%A3%85" target="_blank" rel="noopener">webpack使用PurgecssWebpackPlugin</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 正常方式使用</span></span><br><span class="line"><span class="keyword">const</span> PATHS = &#123;</span><br><span class="line">  src: path.join(__dirname, <span class="string">'src'</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> PurgecssWebpackPlugin(&#123;</span><br><span class="line">            <span class="comment">// 可以直接这样用</span></span><br><span class="line">            paths: glob.sync(<span class="string">`<span class="subst">$&#123;PATHS.src&#125;</span>/**/*`</span>, &#123;<span class="attr">nodir</span>: <span class="literal">true</span>&#125;),</span><br><span class="line">            <span class="comment">// 也可以用globAll来选择具体使用的目录</span></span><br><span class="line">            paths: globAll.sync([</span><br><span class="line">                <span class="string">`<span class="subst">$&#123;PATHS.src&#125;</span>/index.html`</span>,</span><br><span class="line">                <span class="string">`<span class="subst">$&#123;PATHS.src&#125;</span>/styles/*`</span>,</span><br><span class="line">                <span class="string">`<span class="subst">$&#123;PATHS.src&#125;</span>/*/*.vue`</span>,</span><br><span class="line">            ]),</span><br><span class="line">        &#125;)</span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="提取CSS到单独的文件里"><a class="header-anchor" href="#提取CSS到单独的文件里"></a>提取CSS到单独的文件里</h3>
<p>为什么要提取css到单独的文件中呢？项目比较大时，样式会特别多且特别复杂。如果仍然用<code>'style-loader', 'css-loader',  'sass-loader'</code>这种方式的话会大幅延长首页加载时间，且很多样式并不需要在首页加载。所以我们需要对CSS做优化且优化点就在于分离不同模块的样式且最好分离出的模块能够按需加载。</p>
<p>这里就需要用到一个插件来对这种现象进行优化：webpack4的话使用<code>mini-css-extract-plugin</code>，webpack3的话使用<code>extract-text-webpack-plugin</code>。<br>
这两个插件的作用是一样的，但是前者功能更加完善（毕竟是后面出的，肯定优化更好一些）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PATHS = &#123;</span><br><span class="line">  src: path.join(__dirname, <span class="string">'src'</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> isDev = process.env.NODE_ENV === <span class="string">'development'</span></span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">    plugins:[</span><br><span class="line">        <span class="comment">// MiniCssExtractPlugin插件支持css按需加载和sourceMap</span></span><br><span class="line">        <span class="keyword">new</span> MiniCssExtractPlugin(&#123;</span><br><span class="line">            filename: isDev ? [name].css : [name].[contentHash].css,</span><br><span class="line">            chunkFilename: isDev ? [id].css : [id].[contentHash].css</span><br><span class="line">        &#125;),</span><br><span class="line">    ],</span><br><span class="line">    modules:&#123;</span><br><span class="line">        rules:[</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">                use: [MiniCssExtractPlugin.loader, <span class="string">'css-loader'</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">                use: [MiniCssExtractPlugin.loader, <span class="string">'css-loader'</span>, <span class="string">'sass-loader'</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自动添加前缀"><a class="header-anchor" href="#自动添加前缀"></a>自动添加前缀</h3>
<p>由于样式可能会存在浏览器兼容问题，所以我们会需要在样式中添加前缀，但是你也不可能所有的样式都写一边。这里我们可以使用<code>postcss</code>来做这件事情，那么在webpack中我们就需要用到<code>postcss-loader</code>和<code>autoprefixer</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">    plugins:[</span><br><span class="line">        <span class="comment">// MiniCssExtractPlugin插件支持按需加载和sourceMap</span></span><br><span class="line">        <span class="keyword">new</span> MiniCssExtractPlugin(&#123;</span><br><span class="line">            filename: [name].[contentHash].css,</span><br><span class="line">            chunkFilename: [id].[contentHash].css</span><br><span class="line">        &#125;),</span><br><span class="line">        autoPrefixer(&#123;</span><br><span class="line">            browser: [</span><br><span class="line">                <span class="string">'last 10 Chrome versions'</span>,</span><br><span class="line">                <span class="string">'last 5 Firefox versions'</span>,</span><br><span class="line">                <span class="string">'Safari &gt;= 6'</span>, </span><br><span class="line">                <span class="string">'ie&gt; 8'</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;)</span><br><span class="line">    ],</span><br><span class="line">    modules:&#123;</span><br><span class="line">        rules:[</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">                use: [MiniCssExtractPlugin.loader, <span class="string">'css-loader'</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">                use: [MiniCssExtractPlugin.loader, <span class="string">'css-loader'</span>,  <span class="string">'sass-loader'</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="压缩文件"><a class="header-anchor" href="#压缩文件"></a>压缩文件</h3>
<p>首先，webpack4中默认在<code>production</code>时会开启压缩。但是这个压缩是对js文件的压缩，所以css文件我们需要通过<code>optimize-css-assets-webpack-plugin</code>来完成。But，由于配置css压缩时会覆盖掉webpack的默认压缩配置， 所以需要额外引入js压缩插件<code>terser-webpack-plugin</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> OptimizeCssAssetsPlugin = <span class="built_in">require</span>(<span class="string">'optimize-css-assets-webpack-plugin'</span>);</span><br><span class="line"><span class="keyword">const</span> TerserPlugin = <span class="built_in">require</span>(<span class="string">'terser-webpack-plugin'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">    optimization:&#123;</span><br><span class="line">        minimize: <span class="literal">true</span>,</span><br><span class="line">        minimizer:&#123;</span><br><span class="line">            <span class="keyword">new</span> TerserPlugin(&#123;</span><br><span class="line">                parallel: <span class="number">4</span>, <span class="comment">// 并行压缩</span></span><br><span class="line">            &#125;),</span><br><span class="line">            <span class="keyword">new</span> OptimizeCssAssetsPlugin(&#123;&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="JS抽取公共代码"><a class="header-anchor" href="#JS抽取公共代码"></a>JS抽取公共代码</h3>
<p>很多时候，一些公共的代码/库会在应用内各个模块内都用到。但是按照之前的逻辑，webpack打包的时候会把这些代码多次打入进去。这样就会使得构建包的体积增大。所以，我们需要能够把公共代码提取出来，这样子只需要加载一次，其它地方用的时候都要不需要重复加载。</p>
<p>这里我们主要使用的是<code>splitChunkPlugin</code>来抽取公共代码，不过这个插件不需要我们显式的引入使用，在webpack4中可以通过<code>optimization.splitChunks</code>来配置。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack官网给的默认配置。</span></span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">    optimization:&#123;</span><br><span class="line">        splitChunks: &#123;</span><br><span class="line">            chunks: <span class="string">'async'</span>,</span><br><span class="line">            minSize: <span class="number">30000</span>,</span><br><span class="line">            maxSize: <span class="number">0</span>,</span><br><span class="line">            minChunks: <span class="number">1</span>,</span><br><span class="line">            maxAsyncRequests: <span class="number">5</span>,</span><br><span class="line">            maxInitialRequests: <span class="number">3</span>,</span><br><span class="line">            automaticNameDelimiter: <span class="string">'~'</span>,</span><br><span class="line">            name: <span class="literal">true</span>,</span><br><span class="line">            cacheGroups: &#123;</span><br><span class="line">                vendors: &#123;</span><br><span class="line">                    test: <span class="regexp">/[\\/]node_modules[\\/]/</span>,</span><br><span class="line">                    priority: <span class="number">-10</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="keyword">default</span>: &#123;</span><br><span class="line">                    minChunks: <span class="number">2</span>,</span><br><span class="line">                    priority: <span class="number">-20</span>,</span><br><span class="line">                    reuseExistingChunk: <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="chunks"><a class="header-anchor" href="#chunks"></a>chunks</h4>
<p>chunks内有<code>['all', 'async', 'initial']</code>三种模式， 默认为<code>async</code>。</p>
<ul>
<li>async：只从异步加载的模块里进行拆分</li>
<li>initial：只从入口模块进行拆分</li>
<li>all：既从异步加载的模块里进行拆分也从入口模块进行拆分</li>
</ul>
<h3 id="配置多入口"><a class="header-anchor" href="#配置多入口"></a>配置多入口</h3>
<p>多入口其实本质上也是一种分离代码的方式。也是减少初始化需要加载的内容数量。然后是利用<code>webpack.config.entry</code>来配置。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">    <span class="comment">// 两个入口 main，other</span></span><br><span class="line">    entry:&#123;</span><br><span class="line">        main: <span class="string">'main.js'</span>,</span><br><span class="line">        other: <span class="string">'other.js'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    output:&#123;</span><br><span class="line">        <span class="comment">// 只需要这样子写就可以了。 输出的也是main，other</span></span><br><span class="line">        filename: <span class="string">'[name].js'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="noParse"><a class="header-anchor" href="#noParse"></a>noParse</h3>
<p>对于一些引用到的第三方库，我们可以很清晰知道它不会和其它模块产生依赖时。就可以用到<code>noParse</code>。它的作用就是让webpack不去解析这些库的依赖关系。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">    <span class="built_in">module</span>:&#123;</span><br><span class="line">        noParse: <span class="regexp">/jquery|bootstrap/</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="IgnorePlugin"><a class="header-anchor" href="#IgnorePlugin"></a>IgnorePlugin</h3>
<p>对于引用的一些第三方库，例如<code>momentjs，dayjs</code>。他们内部都是自带国际化处理的，那么就会有很多对应的语言包。但是很多时候我们往往不需要这些语言包。这个时候我们就可以通过使用<code>IgnorePlugin</code>来忽略掉所有的语言包，当然，在这之后我们还得按需引入实际要用到的语言包。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// entry.js</span></span><br><span class="line"><span class="keyword">import</span> moment <span class="keyword">from</span> <span class="string">'moment'</span>;</span><br><span class="line"><span class="comment">// 设置为中文</span></span><br><span class="line">moment.locale(<span class="string">'zh-CN'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在这之前我们得通过阅读源码找到moment的语言包目录。这里不细讲了。</span></span><br><span class="line"><span class="comment">// 最后可以找到moment的语言包目录是 /locale</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">    plugins:[</span><br><span class="line">        <span class="comment">// ...其它插件</span></span><br><span class="line">        <span class="keyword">new</span> webpack.IgnorePlugin(<span class="regexp">/\.\/locale/</span>, /moment/)</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// entry.js</span></span><br><span class="line"><span class="keyword">import</span> moment <span class="keyword">from</span> <span class="string">'moment'</span>;</span><br><span class="line"><span class="comment">// 需要手动引入该语言包</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'moment/locale/zh-cn'</span>;</span><br><span class="line"><span class="comment">// 设置为中文</span></span><br><span class="line">moment.locale(<span class="string">'zh-CN'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="DLL预编译优化"><a class="header-anchor" href="#DLL预编译优化"></a>DLL预编译优化</h3>
<p>对于一些不会经常更新的库，例如<code>vue，react</code>等等。这些库我们一般不会更新版本，但是每次打包时都要解析。这样是会影响到webpack的打包速度的。而且就算我们做了拆分，提升的也只是在页面中访问的速度，而不是webpack打包的速度。所以为了提高webpack构建的速度，我们可以采用类似于dll（动态链接库）的方式来提升构建速度。</p>
<p>这样子做的本质其实就是相当于我提前把这一部分不会经常更新的库先打包一遍，这样子我之后webpack打包就只需要打包另外一部分内容。相当于减少了打包的工作量。</p>
<p>DLL优化中我们主要会用到两个插件，一个是<code>DLLPlugin</code>，一个是<code>DLLReferencePlugin</code>。<br>
<code>DLLPlugin</code>呢主要是用来生成dll内容的。dll内容包括打包生成的<code>js</code>文件以及<code>manifest.json</code>（<code>DLLReferencePlugin</code>会使用该json文件来做映射依赖性，同时webpack通过这个文件可以知道哪些文件已经提取打包好了）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dll.config.js</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    mode: <span class="string">'none'</span>,</span><br><span class="line">    entry:&#123;</span><br><span class="line">        vue: [</span><br><span class="line">            <span class="string">'vue/dist/vue'</span>,</span><br><span class="line">            <span class="string">'vue-router'</span>,</span><br><span class="line">            <span class="string">'vuex'</span>,</span><br><span class="line">            <span class="string">'axios'</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    output:&#123;</span><br><span class="line">        path: path.resolve(__dirname, <span class="string">'./public/static/dll'</span>),</span><br><span class="line">        filename: <span class="string">'[name]_[hash].dll.js'</span>,</span><br><span class="line">        library: <span class="string">'[name]_[hash]'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    plugins:[</span><br><span class="line">        <span class="keyword">new</span> webpack.DllPlugin(&#123;</span><br><span class="line">            name: <span class="string">'[name]_[hash]'</span>,</span><br><span class="line">            path: path.resolve(__dirname, <span class="string">'./public/static/dll'</span>, <span class="string">'[name]-manifest.json'</span>),</span><br><span class="line">            context: __dirname</span><br><span class="line">        &#125;)</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="comment">// 引入之前生成的manifest.json</span></span><br><span class="line"><span class="keyword">const</span> dllJson = <span class="built_in">require</span>(<span class="string">'./public/static/dll/vue-manifest.json'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">    plugins:[</span><br><span class="line">        <span class="comment">// ... 其它插件</span></span><br><span class="line">        <span class="comment">// 这里只是成功的引入了dll依赖关系，并没有动态的把它导入到项目里。</span></span><br><span class="line">        <span class="keyword">new</span> webpack.DllReferencePlugin(&#123;</span><br><span class="line">            manifest: dllJson,</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">            template: <span class="string">'index.html'</span>,</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 导入dll到html中方案1</span></span><br><span class="line">            vendor: <span class="string">'/static/dll/'</span> + dllJson.name + <span class="string">'.dll.js'</span></span><br><span class="line">        &#125;),</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 导入dll到html中方案2</span></span><br><span class="line">        <span class="keyword">new</span> AddAssetHtmlWebpackPlugin(&#123;</span><br><span class="line">            filepath: path.resolve(__dirname, <span class="string">`../dist/static/dll/<span class="subst">$&#123;dllJson.name&#125;</span>_dll.js`</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 导入dll到html中方案1</span></span><br><span class="line"><span class="comment">// index.html 注入dll.js </span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">    &lt;div id='app'&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;script src="&lt;%= htmlWebpackPlugin.options.vendor %&gt;"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure>
<h3 id="TreeShaking"><a class="header-anchor" href="#TreeShaking"></a>TreeShaking</h3>
<p><code>TreeShaking</code>的意思就是删除没有用到的冗余代码，可以理解为一个提纯操作。把使用到的代码提取出来然后在打包。可以通过<code>package.json</code>中的<code>sideEffects</code>属性或者是<code>webpack.config.module.rules</code>来设置。</p>
<p><code>sideEffects</code>有三个值：</p>
<ul>
<li>true： 不做tree-shaking</li>
<li>false： 都可以做tree-shaing</li>
<li>[]：对不符合数组内结果的内容做tree-shaking</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// package.json</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 不符合该匹配结果的都会做tree-shaking</span></span><br><span class="line"><span class="string">"sideEffects"</span>: [</span><br><span class="line">    <span class="string">"./src/some-side-effectful-file.js"</span>,</span><br><span class="line">    <span class="string">"*.css"</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">    <span class="built_in">module</span>:&#123;</span><br><span class="line">        rules:[</span><br><span class="line">            &#123;</span><br><span class="line">                include: path.resolve(<span class="string">"node_modules"</span>, <span class="string">"lodash"</span>),</span><br><span class="line">                <span class="comment">// 做tree-shaking</span></span><br><span class="line">                sideEffects: <span class="literal">false</span>, </span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                include: path.resolve(<span class="string">"src/view/home/index.vue"</span>),</span><br><span class="line">                <span class="comment">// 不做tree-shaking</span></span><br><span class="line">                sideEffects: <span class="literal">true</span>, </span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中还有，为了更好的tree-shaking。我们在平时coding的时候，可以这样子做：</p>
<ul>
<li><code>import {cloneDeep} from 'lodash'</code> 代替 <code>import _ from 'lodash'</code></li>
<li><code>import cloneDeep from 'lodash/cloneDeep'</code> 代替 <code>import _ from 'lodash'</code></li>
<li>像项目里常用的的方法库这种，尽量这样子写也有助于tree-shaking  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">export const foo()&#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line">export const foo1()&#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line">export default &#123;</span><br><span class="line">    foo,</span><br><span class="line">    foo1,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="多进程优化构建"><a class="header-anchor" href="#多进程优化构建"></a>多进程优化构建</h3>
<p>首先，由于js本身是一个单线程的语言，所以webpack打包的时候，任务只能一个一个的完成。但是我们又想要webpack能够同时完成多个任务。那怎么办呢？</p>
<p>我们可以通过<code>HappyPack，thread-loader（官方推荐）</code>等插件来使得webpack能够做到多线操作。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isDev = process.env.NODE_ENV === <span class="string">'development'</span>;</span><br><span class="line"><span class="keyword">const</span> HappyPack = <span class="built_in">require</span>(<span class="string">'happypack'</span>);</span><br><span class="line"><span class="keyword">const</span> os = <span class="built_in">require</span>(<span class="string">'os'</span>);</span><br><span class="line"><span class="keyword">const</span> HappyThreadPool = HappyPack.ThreadPool(&#123;<span class="attr">size</span>: os.cpus().length&#125;);</span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">    <span class="built_in">module</span>:&#123;</span><br><span class="line">        rules:[</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">                exclude: <span class="regexp">/node_mudoles/</span>,</span><br><span class="line">                use: <span class="string">'happypack/loader?id=happyBabel'</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">                use: <span class="string">'happypack/loader?id=happyScss'</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    plugins:[</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">new</span> HappyPack(&#123;</span><br><span class="line">            id: <span class="string">'happyBabel'</span>, <span class="comment">// loaders声明的对应的id</span></span><br><span class="line">            threads: <span class="number">4</span>, <span class="comment">// 线程数</span></span><br><span class="line">            loaders:[<span class="string">'babel-loader'</span>] <span class="comment">// loaders</span></span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="keyword">new</span> HappyPack(&#123;</span><br><span class="line">            id: <span class="string">'happyScss'</span>,</span><br><span class="line">            threads: <span class="number">2</span>, </span><br><span class="line">            loaders:[isDev ? <span class="string">'style-loader'</span> : MinicssExtractPlugin.loader,<span class="string">'css-loader'</span>,<span class="string">'sass-loader'</span>]</span><br><span class="line">        &#125;),</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注：由于happyPack作者自身原因（对于js逐渐缺少兴趣），happypack现在已经停止维护。webpack4及以后官方都推荐使用thread-loader。</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isDev = process.env.NODE_ENV === <span class="string">'development'</span>;</span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">    <span class="built_in">module</span>:&#123;</span><br><span class="line">        rules:[</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">                exclude: <span class="regexp">/node_mudoles/</span>,</span><br><span class="line">                use: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        loader: <span class="string">'thread-loader'</span>,</span><br><span class="line">                        options:&#123;</span><br><span class="line">                            workers: <span class="number">2</span>,</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        loader: <span class="string">'babel-loader'</span>,</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">                use: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        loader: <span class="string">'thread-loader'</span>,</span><br><span class="line">                        options:&#123;</span><br><span class="line">                            workers: <span class="number">2</span>,</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    isDev ? <span class="string">'style-loader'</span> : MinicssExtractPlugin.loader,</span><br><span class="line">                    <span class="string">'css-loader'</span>,</span><br><span class="line">                    <span class="string">'sass-loader'</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>另注：由于进程启动大概需要600ms，且进程的通信也是有开销的。所以需要做一个取舍。如果项目比较小的话，多进程可以不开。</strong></p>
<h2 id="总结"><a class="header-anchor" href="#总结"></a>总结</h2>
<p>其实总的来说，优化其实可以分为几个大的方面。</p>
<p>第一是对包体积的优化，主要包括优化冗余css，提取公共代码，tree-shaking，压缩文件）等等方式。其主要目的就是为了使bundle包更小。</p>
<p>第二的话就是优化对bundle包的加载（其实也就是优化首页加载），优化加载的核心思想我认为是分离和按需。主要就是分割完整代码成多个代码片（其实就是main.js ==&gt; bundle1.js,bundle2.js这样），分割出来的文件颗粒度更细。然后再按需加载，这样可以保证分割出的文件只在我需要用到的时候才会加载。主要包括提取css到单独文件中（减小了首页js大小）。</p>
<p>还有一些其它的优化方式，感觉不属于以上两种。但是感觉现在自己说不太明白。不能很好的表达，暂时先不多做赘述了。</p>
<p>最后想说的就是，优化也是一门技术活。需要懂得灵活运用。而不是啥也不管直接把所有的优化方式都弄进来。需要根据项目大小和进度来进行调整。</p>
<h2 id="相关文章"><a class="header-anchor" href="#相关文章"></a>相关文章</h2>
<p><a href="https://xzh97.github.io/2020/11/20/learn-webpack/">【Webpack】基础配置</a></p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>xzh</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://xzh97.github.io/2020/12/03/learn-webpack-optimization/">https://xzh97.github.io/2020/12/03/learn-webpack-optimization/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>最是人间孤愤难平，直消得几回潮落又潮生！</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/webpack/"># webpack</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
            
            <a class="next" rel="next" href="/2020/11/20/learn-webpack/">【Webpack】基础配置</a>
            
        </section>

        
        
        <script type="text/javascript" async>
    let gitalkContainer = document.createElement('div')
    let postWrap = document.querySelector('.post-wrap');
    gitalkContainer.id = 'gitalk-container'
    postWrap.appendChild(gitalkContainer);
    let params = {
    clientID: '73f1c80bba01cb73e53d',
    clientSecret: 'fb38d78684a17e97a441a4cd0db47dc642423678',
    repo: 'xzh97.github.io',
    admin: ['xzh97'],
    id: window.location.pathname,
    owner: 'xzh97',
    distractionFreeMode: false,
    }
    let gitalk = new Gitalk(params)
    gitalk.render('gitalk-container')
</script>
        

    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© xzh | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
